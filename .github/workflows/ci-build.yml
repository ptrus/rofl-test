# ROFL GitHub Actions Examples
#
# This workflow demonstrates all common use cases for the ROFL build/deploy action.
# Each job shows a different scenario - use the one that fits your needs.
#
# Required secrets (Settings > Secrets and variables > Actions > Secrets):
#   - WALLET_SECRET: Mnemonic or private key for direct deployment
#   - SAFE_PROPOSER_KEY: Private key of a Safe multisig owner (for Safe mode)
#
# Required variables (Settings > Secrets and variables > Actions > Variables):
#   - SAFE_ADDRESS: Safe multisig contract address

name: ROFL CI/CD Examples

on:
  push:
    branches: [main]
  pull_request:
  workflow_dispatch:

jobs:
  # ============================================================================
  # SCENARIO 1: Validate Only
  # ============================================================================
  # Web2 equivalent: Linting or config validation (like `docker-compose config`)
  #
  # Use this to catch config errors early without waiting for a full build.
  validate:
    name: Validate ROFL Config
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: oasisprotocol/build-deploy-rofl-action@ptrus/initial-impl
        with:
          network: testnet
          deployment: testnet
          only_validate: true

  # ============================================================================
  # SCENARIO 2: Build Only
  # ============================================================================
  # Web2 equivalent: `docker build` without `docker push`
  #
  # Use this to verify your app compiles successfully.
  build:
    name: Build ROFL App
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: oasisprotocol/build-deploy-rofl-action@ptrus/initial-impl
        with:
          network: testnet
          deployment: testnet
          update_manifest: true
          skip_update: true
          skip_deploy: true

  # ============================================================================
  # SCENARIO 3: Build + Verify (reproducible builds)
  # ============================================================================
  # Web2 equivalent: Verifying a Docker image hash matches what's in production
  #
  # Use this to ensure your local build produces the exact same artifact as
  # what's registered on-chain. Verification is enabled by default.
  verify:
    name: Verify Reproducible Build
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: oasisprotocol/build-deploy-rofl-action@ptrus/initial-impl
        with:
          network: testnet
          deployment: testnet
          skip_update: true
          skip_deploy: true

  # ============================================================================
  # SCENARIO 4: Test Deployment (auto-update manifest)
  # ============================================================================
  # Web2 equivalent: Dev environment with auto-deploy on every push
  #
  # Use this for test/dev environments where you want automatic enclave ID updates.
  # WARNING: Not recommended for production - enclave IDs should be reviewed.
  test-deploy:
    name: Test Deployment (auto-update)
    runs-on: ubuntu-latest
    # Only on main branch pushes, not PRs
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    steps:
      - uses: actions/checkout@v4
      - uses: oasisprotocol/build-deploy-rofl-action@ptrus/initial-impl
        with:
          network: testnet
          deployment: testnet
          update_manifest: true
          wallet_account: ci_account
          wallet_import: true
          wallet_secret: ${{ secrets.WALLET_SECRET }}
          wallet_algorithm: secp256k1-raw

  # ============================================================================
  # SCENARIO 5: Full Deployment (production, single-key)
  # ============================================================================
  # Web2 equivalent: `docker build && docker push && kubectl apply`
  #
  # Use this for testnet or when a single deployer key is acceptable.
  # The wallet secret signs and broadcasts transactions directly.
  # Requires: WALLET_SECRET with sufficient balance for gas fees
  deploy:
    name: Full Deployment
    runs-on: ubuntu-latest
    # Only deploy on main branch pushes, not PRs
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    steps:
      - uses: actions/checkout@v4
      - uses: oasisprotocol/build-deploy-rofl-action@ptrus/initial-impl
        with:
          network: testnet
          deployment: testnet
          wallet_account: ci_account
          wallet_import: true
          wallet_secret: ${{ secrets.WALLET_SECRET }}
          wallet_algorithm: secp256k1-raw
          verbose: true

  # ============================================================================
  # SCENARIO 6: Safe Multisig Deployment (https://safe.oasis.io/)
  # ============================================================================
  # Web2 equivalent: Creating a deployment PR that requires multiple approvals
  #
  # Use this for production deployments where no single person should have
  # deploy access. The transaction is proposed to a Safe multisig wallet,
  # and other team members approve it via the Safe UI before it executes.
  #
  # Requires:
  #   - SAFE_PROPOSER_KEY: Private key of an EOA that is a Safe owner
  #   - SAFE_ADDRESS variable configured
  safe-proposal:
    name: Safe Multisig Proposal
    runs-on: ubuntu-latest
    # Only propose on main branch pushes
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    steps:
      - uses: actions/checkout@v4
      - uses: oasisprotocol/build-deploy-rofl-action@ptrus/initial-impl
        with:
          network: testnet
          deployment: testnet
          update_manifest: true
          unsigned: true
          format: cbor
          update_output_file: update.cbor
          skip_deploy: true
          safe_address: ${{ vars.SAFE_ADDRESS }}
          safe_proposer_key: ${{ secrets.SAFE_PROPOSER_KEY }}

  # ============================================================================
  # SCENARIO 7: Generate Unsigned Transactions (manual signing)
  # ============================================================================
  # Web2 equivalent: Generating deployment manifests for manual review/apply
  #
  # Use this when you need to sign transactions outside of CI, such as with
  # a hardware wallet (Ledger) or air-gapped machine. Downloads the CBOR
  # files as artifacts, which you then sign and broadcast manually.
  offline-build:
    name: Generate Unsigned Transactions
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: oasisprotocol/build-deploy-rofl-action@ptrus/initial-impl
        with:
          network: testnet
          deployment: testnet
          update_manifest: true
          unsigned: true
          format: cbor
          update_output_file: update.cbor
          deploy_output_file: deploy.cbor
          skip_deploy: true

      - uses: actions/upload-artifact@v4
        with:
          name: rofl-transactions
          path: |
            update.cbor
            deploy.cbor
          retention-days: 7
